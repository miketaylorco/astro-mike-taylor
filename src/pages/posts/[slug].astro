---
import type { SanityDocument } from "@sanity/client";
import { sanityClient } from "sanity:client";
import { createImageUrlBuilder, type SanityImageSource } from "@sanity/image-url";
import { PortableText } from "astro-portabletext";
import ImageWithCaption from "../../components/ImageWithCaption.astro";
import YouTube from "../../components/YouTube.astro";
import ImageGallery from "../../components/ImageGallery.astro";
import PortableTextBlock from "../../components/PortableTextBlock.astro";
import ProtectedContent from "../../components/ProtectedContent.astro";
import { getUser } from "../../lib/supabase";

import Main from '../../layouts/main.astro';

// Server-render this page to check authentication
export const prerender = false;

const contentProps = { title: "Posts" };

// Check if user is authenticated
const user = await getUser(Astro.cookies);
const isAuthenticated = !!user;

// Fetch post with access level and teaser fields
const POST_QUERY = `*[_type == "post" && slug.current == $slug][0]{
  _id,
  title,
  slug,
  publishedAt,
  image,
  accessLevel,
  teaser,
  teaserImage,
  "body": select(
    accessLevel == "protected" => null,
    body
  )
}`;
const post = await sanityClient.fetch<SanityDocument>(POST_QUERY, Astro.params);

const { projectId, dataset } = sanityClient.config();
const urlFor = (source: SanityImageSource) =>
  projectId && dataset
    ? createImageUrlBuilder({ projectId, dataset }).image(source)
    : null;

const postImageUrl = post.image
  ? urlFor(post.image)?.width(550).height(310).url()
  : null;

const teaserImageUrl = post.teaserImage
  ? urlFor(post.teaserImage)?.width(550).height(310).url()
  : null;

const isProtected = post.accessLevel === 'protected';
const returnUrl = `/posts/${post.slug.current}`;

// Portable text components config
const portableTextComponents = {
  type: {
    imageWithCaption: ImageWithCaption,
    youtube: YouTube,
    imageGallery: ImageGallery,
  },
  block: {
    lead: PortableTextBlock,
    small: PortableTextBlock,
    callout: PortableTextBlock,
    blockquote: PortableTextBlock,
    h1: PortableTextBlock,
    h2: PortableTextBlock,
    h3: PortableTextBlock,
    h4: PortableTextBlock,
    normal: PortableTextBlock,
  },
};
---

<Main content={contentProps}>
<main class="container mx-auto min-h-screen max-w-3xl p-8 flex flex-col gap-4">
  <div class="flex items-center justify-between">
    <a href="/posts" class="hover:underline">&larr; Back to posts</a>
    {isAuthenticated && (
      <a href="/api/auth/signout" class="text-sm text-gray-500 hover:underline">Sign out</a>
    )}
  </div>

  {isProtected && (
    <div class="inline-flex items-center gap-2 bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm w-fit">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
      Protected Content
    </div>
  )}

  {postImageUrl && (
    <img
      src={postImageUrl}
      alt={post.title}
      class="aspect-video rounded-xl"
      width="550"
      height="310"
    />
  )}

  <h1 class="text-4xl font-bold mb-8">{post.title}</h1>

  <div class="prose">
    <p>Published: {new Date(post.publishedAt).toLocaleDateString()}</p>

    {isProtected ? (
      <ProtectedContent
        documentId={post._id}
        isAuthenticated={isAuthenticated}
        returnUrl={returnUrl}
        postTitle={post.title}
      >
        <Fragment slot="teaser">
          {Array.isArray(post.teaser) && post.teaser.length > 0 && (
            <div class="teaser-content mb-8">
              <PortableText
                value={post.teaser}
                components={portableTextComponents}
              />
            </div>
          )}

          {teaserImageUrl && (
            <img
              src={teaserImageUrl}
              alt={`${post.title} teaser`}
              class="rounded-lg mb-8"
              width="550"
              height="310"
            />
          )}
        </Fragment>
      </ProtectedContent>
    ) : (
      Array.isArray(post.body) && (
        <PortableText
          value={post.body}
          components={portableTextComponents}
        />
      )
    )}
  </div>
</main>
</Main>
