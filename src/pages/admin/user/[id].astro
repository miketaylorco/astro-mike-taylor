---
import Main from '../../../layouts/main.astro';
import { getUser, isAdmin, createSupabaseAdminClient } from '../../../lib/supabase';
import { sanityClient } from "sanity:client";

export const prerender = false;

const contentProps = { title: "Manage User" };

const { id: userId } = Astro.params;

if (!userId) {
  return Astro.redirect('/admin');
}

// Check authentication and admin status
const user = await getUser(Astro.cookies);

if (!user) {
  return Astro.redirect(`/auth/signin?next=/admin/user/${userId}`);
}

if (!isAdmin(user.email)) {
  return Astro.redirect('/auth/error?message=access_denied');
}

const supabaseAdmin = createSupabaseAdminClient();

// Get user profile
const { data: profile, error: profileError } = await supabaseAdmin
  .from('profiles')
  .select('*')
  .eq('id', userId)
  .single();

if (profileError || !profile) {
  return Astro.redirect('/admin');
}

// Get user's article access
const { data: userAccess } = await supabaseAdmin
  .from('article_access')
  .select('*')
  .eq('user_id', userId);

// Get user's recent access logs
const { data: accessLogs } = await supabaseAdmin
  .from('content_access_log')
  .select('*')
  .eq('user_id', userId)
  .order('accessed_at', { ascending: false })
  .limit(20);

// Get protected articles from Sanity
const protectedArticles = await sanityClient.fetch(`
  *[_type == "post" && accessLevel == "protected"]{
    _id,
    title,
    slug
  }
`);

// Map access to article IDs
const accessedArticleIds = new Set(userAccess?.map((a: any) => a.sanity_document_id) || []);

// Check if user has full access
const hasFullAccess = profile.has_full_access || false;
---

<Main content={contentProps}>
<main class="container mx-auto min-h-screen max-w-3xl p-8">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold">Manage User</h1>
    <a href="/admin" class="text-gray-500 hover:underline">&larr; Back to Dashboard</a>
  </div>

  <!-- User Info -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-semibold mb-4">User Information</h2>
    <dl class="grid grid-cols-2 gap-4">
      <div>
        <dt class="text-sm text-gray-500">Email</dt>
        <dd class="font-medium">{profile.email}</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Display Name</dt>
        <dd class="font-medium">{profile.display_name || '—'}</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">Created</dt>
        <dd class="font-medium">{new Date(profile.created_at).toLocaleDateString()}</dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">User ID</dt>
        <dd class="font-mono text-sm">{profile.id}</dd>
      </div>
    </dl>
  </div>

  <!-- Full Access Permission -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-semibold mb-4">Full Access Permission</h2>
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-700">
          {hasFullAccess
            ? 'This user has full access to all protected content.'
            : 'Grant full access to bypass per-article permissions.'}
        </p>
        {hasFullAccess && (
          <p class="text-sm text-amber-600 mt-1">
            Individual article access settings are bypassed when full access is enabled.
          </p>
        )}
      </div>
      <button
        type="button"
        id="full-access-toggle"
        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
        data-user-id={userId}
        data-has-full-access={hasFullAccess.toString()}
        style={hasFullAccess
          ? "background-color: rgb(220 38 38); color: white;"
          : "background-color: rgb(22 163 74); color: white;"}
      >
        {hasFullAccess ? 'Revoke Full Access' : 'Grant Full Access'}
      </button>
    </div>
  </div>

  <!-- Article Access -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-semibold mb-4">Article Access</h2>

    {protectedArticles && protectedArticles.length > 0 ? (
      <div class="space-y-3">
        {protectedArticles.map((article: any) => {
          const hasAccess = accessedArticleIds.has(article._id);
          return (
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
              <div>
                <div class="font-medium">{article.title}</div>
                <div class="text-sm text-gray-500">{article._id}</div>
              </div>
              {hasAccess ? (
                <button
                  type="button"
                  class="access-toggle px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                  data-user-id={userId}
                  data-article-id={article._id}
                  data-has-access="true"
                  style="background-color: rgb(220 38 38); color: white;"
                >
                  Revoke Access
                </button>
              ) : (
                <div class="relative inline-flex grant-access-dropdown">
                  <button
                    type="button"
                    class="grant-btn px-4 py-2 rounded-l-lg text-sm font-medium transition-colors"
                    data-user-id={userId}
                    data-article-id={article._id}
                    data-send-email="false"
                    style="background-color: rgb(22 163 74); color: white;"
                  >
                    Grant Access
                  </button>
                  <button
                    type="button"
                    class="dropdown-toggle px-2 py-2 rounded-r-lg text-sm font-medium transition-colors border-l border-green-700"
                    style="background-color: rgb(22 163 74); color: white;"
                    aria-label="More options"
                  >
                    ▼
                  </button>
                  <div class="dropdown-menu hidden absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[180px]">
                    <button
                      type="button"
                      class="dropdown-item w-full text-left px-4 py-2 text-sm hover:bg-gray-100 rounded-t-lg"
                      data-user-id={userId}
                      data-article-id={article._id}
                      data-send-email="false"
                    >
                      Grant Access
                    </button>
                    <button
                      type="button"
                      class="dropdown-item w-full text-left px-4 py-2 text-sm hover:bg-gray-100 rounded-b-lg"
                      data-user-id={userId}
                      data-article-id={article._id}
                      data-send-email="true"
                    >
                      Grant Access + Notify
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>
    ) : (
      <p class="text-gray-500">No protected articles found.</p>
    )}
  </div>

  <!-- Access History -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-4">Access History</h2>

    {accessLogs && accessLogs.length > 0 ? (
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 px-2">Article</th>
              <th class="text-left py-2 px-2">Date</th>
              <th class="text-left py-2 px-2">IP</th>
            </tr>
          </thead>
          <tbody>
            {accessLogs.map((log: any) => (
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 font-mono text-xs truncate max-w-[200px]">
                  {log.sanity_document_id}
                </td>
                <td class="py-2 px-2">
                  {new Date(log.accessed_at).toLocaleString()}
                </td>
                <td class="py-2 px-2 text-gray-500">
                  {log.ip_address || '—'}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <p class="text-gray-500">No access history yet.</p>
    )}
  </div>
</main>
</Main>

<script>
  // Full access toggle handler
  const fullAccessBtn = document.getElementById('full-access-toggle') as HTMLButtonElement;
  if (fullAccessBtn) {
    fullAccessBtn.addEventListener('click', async () => {
      const userId = fullAccessBtn.dataset.userId;
      const hasFullAccess = fullAccessBtn.dataset.hasFullAccess === 'true';

      fullAccessBtn.disabled = true;
      fullAccessBtn.textContent = 'Loading...';

      try {
        const response = await fetch('/api/admin/set-full-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            hasFullAccess: !hasFullAccess,
          }),
        });

        if (response.ok) {
          // Reload the page to reflect changes
          window.location.reload();
        } else {
          const data = await response.json();
          alert(data.error || 'Operation failed');
          fullAccessBtn.textContent = hasFullAccess ? 'Revoke Full Access' : 'Grant Full Access';
        }
      } catch (error) {
        alert('An error occurred');
        fullAccessBtn.textContent = hasFullAccess ? 'Revoke Full Access' : 'Grant Full Access';
      } finally {
        fullAccessBtn.disabled = false;
      }
    });
  }

  // Article access toggle handlers (for revoke buttons)
  document.querySelectorAll('.access-toggle').forEach(button => {
    button.addEventListener('click', async (e) => {
      const btn = e.target as HTMLButtonElement;
      const userId = btn.dataset.userId;
      const articleId = btn.dataset.articleId;

      btn.disabled = true;
      btn.textContent = 'Loading...';

      try {
        const response = await fetch('/api/admin/revoke-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            sanityDocumentId: articleId,
          }),
        });

        if (response.ok) {
          // Reload the page to reflect changes
          window.location.reload();
        } else {
          const data = await response.json();
          alert(data.error || 'Operation failed');
          btn.textContent = 'Revoke Access';
        }
      } catch (error) {
        alert('An error occurred');
        btn.textContent = 'Revoke Access';
      } finally {
        btn.disabled = false;
      }
    });
  });

  // Grant access function
  async function grantAccess(userId: string, articleId: string, sendEmail: boolean, triggerBtn: HTMLButtonElement) {
    const dropdown = triggerBtn.closest('.grant-access-dropdown');
    const mainBtn = dropdown?.querySelector('.grant-btn') as HTMLButtonElement;
    const dropdownToggle = dropdown?.querySelector('.dropdown-toggle') as HTMLButtonElement;

    if (mainBtn) {
      mainBtn.disabled = true;
      mainBtn.textContent = 'Loading...';
    }
    if (dropdownToggle) {
      dropdownToggle.disabled = true;
    }

    try {
      const response = await fetch('/api/admin/grant-access', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId,
          sanityDocumentId: articleId,
          sendEmail,
        }),
      });

      if (response.ok) {
        // Reload the page to reflect changes
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'Operation failed');
        if (mainBtn) {
          mainBtn.textContent = 'Grant Access';
        }
      }
    } catch (error) {
      alert('An error occurred');
      if (mainBtn) {
        mainBtn.textContent = 'Grant Access';
      }
    } finally {
      if (mainBtn) {
        mainBtn.disabled = false;
      }
      if (dropdownToggle) {
        dropdownToggle.disabled = false;
      }
    }
  }

  // Main grant button click handlers
  document.querySelectorAll('.grant-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
      const btn = e.target as HTMLButtonElement;
      const userId = btn.dataset.userId!;
      const articleId = btn.dataset.articleId!;
      const sendEmail = btn.dataset.sendEmail === 'true';
      await grantAccess(userId, articleId, sendEmail, btn);
    });
  });

  // Dropdown toggle handlers
  document.querySelectorAll('.dropdown-toggle').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = (e.target as HTMLElement).closest('.grant-access-dropdown');
      const menu = dropdown?.querySelector('.dropdown-menu');

      // Close all other dropdowns first
      document.querySelectorAll('.dropdown-menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
      });

      menu?.classList.toggle('hidden');
    });
  });

  // Dropdown item click handlers
  document.querySelectorAll('.dropdown-item').forEach(button => {
    button.addEventListener('click', async (e) => {
      const btn = e.target as HTMLButtonElement;
      const userId = btn.dataset.userId!;
      const articleId = btn.dataset.articleId!;
      const sendEmail = btn.dataset.sendEmail === 'true';

      // Close dropdown
      const menu = btn.closest('.dropdown-menu');
      menu?.classList.add('hidden');

      await grantAccess(userId, articleId, sendEmail, btn);
    });
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
      menu.classList.add('hidden');
    });
  });
</script>
